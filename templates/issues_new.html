<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Issues - {{ division.display_name }} - EOS Platform</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Inter', Arial, sans-serif;
            background: #f5f5f5; color: #2a2a2a; line-height: 1.6;
        }

        /* === HEADER === */
        .header {
            background: #1a1a1a; color: white; padding: 20px 40px;
            display: flex; justify-content: space-between; align-items: center;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1); position: sticky; top: 0; z-index: 100;
        }
        .header-left { display: flex; align-items: center; gap: 16px; }
        .back-link { color: #b0b0b0; text-decoration: none; font-size: 14px; transition: color 0.2s; }
        .back-link:hover { color: white; }
        .header h1 { font-size: 24px; font-weight: 600; }
        .header-right { display: flex; gap: 16px; align-items: center; }
        .user-info { font-size: 14px; color: #b0b0b0; }
        .btn-logout {
            padding: 8px 16px; background: transparent; border: 1px solid #4a4a4a;
            color: white; border-radius: 4px; font-size: 13px; text-decoration: none; transition: all 0.2s;
        }
        .btn-logout:hover { background: #2d2d2d; border-color: #6a6a6a; }
        .btn-brainstorm {
            padding: 8px 18px; background: #7c3aed; color: white; border-radius: 6px;
            font-size: 13px; font-weight: 600; text-decoration: none; transition: all 0.2s;
        }
        .btn-brainstorm:hover { background: #6d28d9; }

        /* === LAYOUT === */
        .container { max-width: 1400px; margin: 40px auto; padding: 0 40px; }
        .page-title { margin-bottom: 32px; }
        .page-title h2 { font-size: 32px; font-weight: 700; letter-spacing: -0.02em; margin-bottom: 4px; }
        .page-title p { font-size: 14px; color: #6a6a6a; }

        /* === SUMMARY CARDS === */
        .summary-cards {
            display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 16px; margin-bottom: 32px;
        }
        .summary-card {
            background: white; padding: 24px; border-radius: 8px;
            border: 1px solid #e5e5e5; transition: all 0.2s;
        }
        .summary-card:hover { box-shadow: 0 4px 12px rgba(0,0,0,0.06); }
        .summary-card-label {
            font-size: 11px; color: #8a8a8a; text-transform: uppercase;
            letter-spacing: 0.05em; margin-bottom: 8px;
        }
        .summary-card-value { font-size: 32px; font-weight: 700; color: #1a1a1a; line-height: 1.2; }

        /* === FILTER BAR === */
        .filter-bar {
            display: flex; gap: 8px; margin-bottom: 24px; align-items: center; flex-wrap: wrap;
        }
        .filter-btn {
            padding: 8px 16px; border-radius: 6px; font-size: 13px; font-weight: 600;
            cursor: pointer; border: 1px solid #e0e0e0; background: white; color: #555;
            transition: all 0.2s;
        }
        .filter-btn.active { background: #1a1a1a; color: white; border-color: #1a1a1a; }
        .filter-btn:hover { border-color: #999; }
        .filter-divider { width: 1px; height: 24px; background: #e0e0e0; margin: 0 4px; }

        /* === QUICK ADD === */
        .quick-add-section {
            background: white; border: 1px solid #e0e0e0; border-radius: 8px;
            margin-bottom: 32px; overflow: hidden;
        }
        .quick-add-bar {
            display: flex; gap: 12px; padding: 16px 24px; align-items: center; flex-wrap: wrap;
        }
        .quick-add-bar input, .quick-add-bar select {
            padding: 10px 14px; border: 1px solid #e5e5e5; border-radius: 6px;
            font-size: 14px; outline: none; transition: border-color 0.2s; background: #fafafa;
        }
        .quick-add-bar input:focus, .quick-add-bar select:focus { border-color: #1a1a1a; background: white; }
        .quick-add-bar input[type="text"] { flex: 1; min-width: 220px; }
        .quick-add-bar select { min-width: 100px; }
        .btn-add {
            padding: 10px 20px; background: #1a1a1a; color: white; border: none;
            border-radius: 6px; font-size: 14px; font-weight: 600; cursor: pointer;
            transition: all 0.2s; white-space: nowrap;
        }
        .btn-add:hover { background: #333; }

        /* === SECTION === */
        .section { margin-bottom: 32px; }
        .section-header {
            font-size: 13px; font-weight: 700; color: #6a6a6a; text-transform: uppercase;
            letter-spacing: 0.05em; margin-bottom: 16px; padding-bottom: 8px;
            border-bottom: 2px solid #e5e5e5; display: flex; justify-content: space-between;
        }

        /* === ISSUE CARD === */
        .issue-card {
            background: white; border: 1px solid #e5e5e5; border-radius: 8px;
            padding: 24px; margin-bottom: 12px; transition: all 0.2s;
            position: relative;
        }
        .issue-card:hover { border-color: #ccc; box-shadow: 0 4px 12px rgba(0,0,0,0.06); }
        .issue-card.high-priority { border-left: 3px solid #dc3545; }
        .issue-card.resolved-card { opacity: 0.5; }
        .issue-card.resolved-card:hover { opacity: 0.7; }

        .issue-card-header {
            display: flex; justify-content: space-between; align-items: flex-start;
            margin-bottom: 16px; gap: 12px;
        }
        .issue-text-input {
            font-size: 16px; font-weight: 600; color: #1a1a1a; border: none;
            background: transparent; outline: none; width: 100%; padding: 0;
            flex: 1; min-width: 0;
        }
        .issue-text-input:focus { border-bottom: 2px solid #1a1a1a; padding-bottom: 2px; }
        .resolved-card .issue-text-input { text-decoration: line-through; color: #999; }

        .issue-badges { display: flex; gap: 8px; align-items: center; flex-shrink: 0; }

        .badge {
            font-size: 11px; font-weight: 700; padding: 4px 12px; border-radius: 4px;
            border: none; cursor: pointer; text-transform: uppercase; letter-spacing: 0.03em;
            outline: none; -webkit-appearance: none; appearance: none; white-space: nowrap;
        }
        .badge-HIGH { background: #fee2e2; color: #991b1b; }
        .badge-MEDIUM { background: #fef3c7; color: #92400e; }
        .badge-LOW { background: #d1fae5; color: #065f46; }
        .badge-IDENTIFY { background: #dbeafe; color: #1e40af; }
        .badge-DISCUSS { background: #e0e7ff; color: #4338ca; }
        .badge-SOLVE { background: #d4edda; color: #155724; }

        .issue-meta {
            display: flex; gap: 24px; align-items: center; flex-wrap: wrap;
        }
        .meta-group { display: flex; flex-direction: column; }
        .meta-label {
            font-size: 11px; color: #8a8a8a; text-transform: uppercase;
            letter-spacing: 0.05em; margin-bottom: 2px;
        }
        .meta-value-input {
            font-size: 14px; font-weight: 500; color: #1a1a1a; border: none;
            background: transparent; outline: none; padding: 2px 0;
        }
        .meta-value-input:focus { border-bottom: 1px solid #1a1a1a; }
        .meta-value-input::placeholder { color: #ccc; }

        .issue-notes-section {
            margin-top: 16px; padding-top: 16px; border-top: 1px solid #f0f0f0;
            display: none;
        }
        .issue-notes-section.visible { display: block; }
        .issue-notes-section textarea {
            width: 100%; min-height: 80px; border: 1px solid #e5e5e5; border-radius: 6px;
            padding: 12px 14px; font-size: 14px; font-family: inherit; resize: vertical;
            outline: none; background: #fafafa; transition: all 0.2s;
        }
        .issue-notes-section textarea:focus { border-color: #1a1a1a; background: white; }

        .issue-actions {
            position: absolute; top: 16px; right: 16px;
            opacity: 0; transition: opacity 0.2s; display: flex; gap: 4px; align-items: center;
        }
        .issue-card:hover .issue-actions { opacity: 1; }

        .btn-notes {
            background: none; border: 1px solid #e5e5e5; color: #999; font-size: 12px;
            cursor: pointer; padding: 4px 10px; border-radius: 4px; transition: all 0.15s;
            font-weight: 600;
        }
        .btn-notes:hover { color: #555; background: #f5f5f5; border-color: #ccc; }
        .btn-resolve {
            background: none; border: 1px solid #059669; color: #059669; font-size: 12px;
            cursor: pointer; padding: 4px 10px; border-radius: 4px; transition: all 0.15s;
            font-weight: 600;
        }
        .btn-resolve:hover { background: #059669; color: white; }
        .btn-reopen {
            background: none; border: 1px solid #6c757d; color: #6c757d; font-size: 12px;
            cursor: pointer; padding: 4px 10px; border-radius: 4px; transition: all 0.15s;
            font-weight: 600;
        }
        .btn-reopen:hover { background: #6c757d; color: white; }
        .btn-icon {
            background: none; border: none; color: #ccc; font-size: 18px;
            cursor: pointer; padding: 4px 8px; border-radius: 4px; transition: all 0.15s;
        }
        .btn-icon:hover { color: #dc3545; background: #fef2f2; }

        /* === EMPTY STATE === */
        .empty-state {
            text-align: center; padding: 60px 40px; color: #999;
        }
        .empty-state-icon { font-size: 48px; margin-bottom: 16px; opacity: 0.3; }
        .empty-state h3 { font-size: 18px; font-weight: 600; color: #666; margin-bottom: 8px; }
        .empty-state p { font-size: 14px; }

        /* === TOAST === */
        .toast {
            position: fixed; bottom: 24px; right: 24px; padding: 14px 28px;
            background: #1a1a1a; color: white; border-radius: 8px; font-size: 14px;
            font-weight: 500; transform: translateY(80px); opacity: 0; transition: all 0.3s;
            z-index: 999; box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        .toast.visible { transform: translateY(0); opacity: 1; }
        .toast.toast-success { background: #065f46; }
        .toast.toast-error { background: #9b1c1c; }

        @media (max-width: 768px) {
            .container { padding: 0 16px; margin: 24px auto; }
            .summary-cards { grid-template-columns: repeat(2, 1fr); }
            .issue-meta { gap: 12px; }
            .quick-add-bar { flex-wrap: wrap; }
            .issue-badges { flex-wrap: wrap; }
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="header-left">
            <a href="{{ url_for('division_dashboard', division_id=division.id) }}" class="back-link">&#8592; {{ division.display_name }}</a>
            <h1>Issues List</h1>
        </div>
        <div class="header-right">
            <span class="user-info">{{ user.full_name or user.username }}</span>
            <a href="{{ url_for('issue_brainstorm', division_id=division.id) }}" class="btn-brainstorm">&#9889; Brainstorm</a>
            <a href="{{ url_for('logout') }}" class="btn-logout">Logout</a>
        </div>
    </div>

    <div class="container">
        <div class="page-title">
            <h2>{{ division.display_name }} Issues</h2>
            <p>Identify, Discuss, Solve &mdash; Tackle obstacles to keep the team moving forward</p>
        </div>

        <!-- Summary Cards -->
        <div class="summary-cards">
            <div class="summary-card">
                <div class="summary-card-label">Total Issues</div>
                <div class="summary-card-value" id="statTotal">0</div>
            </div>
            <div class="summary-card">
                <div class="summary-card-label">Open</div>
                <div class="summary-card-value" style="color:#dc3545;" id="statOpen">0</div>
            </div>
            <div class="summary-card">
                <div class="summary-card-label">In Progress</div>
                <div class="summary-card-value" style="color:#f59e0b;" id="statInProgress">0</div>
            </div>
            <div class="summary-card">
                <div class="summary-card-label">Resolved</div>
                <div class="summary-card-value" style="color:#059669;" id="statResolved">0</div>
            </div>
            <div class="summary-card">
                <div class="summary-card-label">High Priority</div>
                <div class="summary-card-value" style="color:#991b1b;" id="statHigh">0</div>
            </div>
        </div>

        <!-- Filter Bar -->
        <div class="filter-bar">
            <button class="filter-btn active" onclick="setFilter('ALL',this)">All</button>
            <button class="filter-btn" onclick="setFilter('OPEN',this)">Open</button>
            <button class="filter-btn" onclick="setFilter('IN PROGRESS',this)">In Progress</button>
            <button class="filter-btn" onclick="setFilter('RESOLVED',this)">Resolved</button>
            <div class="filter-divider"></div>
            <button class="filter-btn" onclick="setFilter('HIGH',this)">High</button>
            <button class="filter-btn" onclick="setFilter('MEDIUM',this)">Medium</button>
            <button class="filter-btn" onclick="setFilter('LOW',this)">Low</button>
        </div>

        <!-- Quick Add -->
        {% if can_edit %}
        <div class="quick-add-section">
            <div class="quick-add-bar">
                <input type="text" id="qaIssue" placeholder="&#43; Identify a new issue..." onkeydown="if(event.key==='Enter')addIssue()">
                <select id="qaOwner">
                    <option value="">Owner...</option>
                    {% for u in users %}
                    <option value="{{ u.full_name }}">{{ u.full_name }}</option>
                    {% endfor %}
                </select>
                <select id="qaPriority">
                    <option value="MEDIUM">Medium</option>
                    <option value="HIGH">High</option>
                    <option value="LOW">Low</option>
                </select>
                <select id="qaCategory">
                    <option value="ADMINISTRATIVE">Admin</option>
                    <option value="CUSTOMER">Customer</option>
                    <option value="EMPLOYEE">Employee</option>
                    <option value="PROCESS">Process</option>
                    <option value="FINANCIAL">Financial</option>
                    <option value="STRATEGIC">Strategic</option>
                </select>
                <button class="btn-add" onclick="addIssue()">Add Issue</button>
            </div>
        </div>
        {% endif %}

        <!-- Open Issues -->
        <div class="section" id="openSection">
            <div class="section-header">
                <span>Open Issues</span>
                <span id="openCount">0</span>
            </div>
            <div id="issueList"></div>
        </div>

        <!-- Resolved Issues -->
        <div class="section" id="resolvedSection" style="display:none;">
            <div class="section-header">
                <span>Resolved</span>
                <span id="resolvedCount">0</span>
            </div>
            <div id="resolvedList"></div>
        </div>
    </div>

    <!-- Toast -->
    <div class="toast" id="toast"></div>

    <script>
    const DIVISION_ID = {{ division.id }};
    const CAN_EDIT = {{ 'true' if can_edit else 'false' }};
    let allIssues = [];
    let saveTimers = {};
    let currentFilter = 'ALL';

    function api(url, opts = {}) {
        opts.headers = opts.headers || {};
        if (opts.body && typeof opts.body === 'object' && !(opts.body instanceof FormData)) {
            opts.headers['Content-Type'] = 'application/json';
            opts.body = JSON.stringify(opts.body);
        }
        return fetch(url, opts).then(r => { if (!r.ok) throw new Error('HTTP ' + r.status); return r.json(); });
    }

    function loadIssues() {
        api('/api/division/' + DIVISION_ID + '/issues/all')
            .then(data => { allIssues = data.issues || data; render(); })
            .catch(() => showToast('Failed to load issues', 'error'));
    }

    function setFilter(f, btn) {
        currentFilter = f;
        document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
        if (btn) btn.classList.add('active');
        render();
    }

    function filterIssues(issues) {
        if (currentFilter === 'ALL') return issues;
        if (['HIGH','MEDIUM','LOW'].includes(currentFilter)) {
            return issues.filter(i => i.priority === currentFilter);
        }
        return issues.filter(i => i.status === currentFilter);
    }

    function render() {
        const open = allIssues.filter(i => i.status !== 'RESOLVED');
        const resolved = allIssues.filter(i => i.status === 'RESOLVED');
        const filteredOpen = filterIssues(open);
        const filteredResolved = filterIssues(resolved);

        document.getElementById('issueList').innerHTML = filteredOpen.length
            ? filteredOpen.map(i => issueCard(i, false)).join('')
            : `<div class="empty-state"><div class="empty-state-icon">&#10003;</div><h3>No Open Issues</h3><p>The team is clear! Add a new issue above to start IDS.</p></div>`;

        document.getElementById('resolvedList').innerHTML = filteredResolved.map(i => issueCard(i, true)).join('');
        document.getElementById('openCount').textContent = filteredOpen.length;
        document.getElementById('resolvedCount').textContent = filteredResolved.length;
        document.getElementById('resolvedSection').style.display = filteredResolved.length ? 'block' : 'none';

        // Stats
        document.getElementById('statTotal').textContent = allIssues.length;
        document.getElementById('statOpen').textContent = open.filter(i => i.status === 'OPEN').length;
        document.getElementById('statInProgress').textContent = open.filter(i => i.status === 'IN PROGRESS').length;
        document.getElementById('statResolved').textContent = resolved.length;
        document.getElementById('statHigh').textContent = allIssues.filter(i => i.priority === 'HIGH' && i.status !== 'RESOLVED').length;
    }

    function esc(str) { const d = document.createElement('div'); d.textContent = str || ''; return d.innerHTML; }

    function issueCard(i, isResolved) {
        const pClass = 'badge-' + (i.priority || 'MEDIUM');
        const idsClass = 'badge-' + (i.ids_stage || 'IDENTIFY');
        const highPri = i.priority === 'HIGH' && !isResolved ? ' high-priority' : '';
        const resolvedClass = isResolved ? ' resolved-card' : '';

        return `
        <div class="issue-card${highPri}${resolvedClass}" data-id="${i.id}">
            ${CAN_EDIT ? `
            <div class="issue-actions">
                <button class="btn-notes" onclick="toggleNotes(${i.id})">Notes</button>
                <button class="${isResolved ? 'btn-reopen' : 'btn-resolve'}" onclick="resolveIssue(${i.id},${!isResolved})">${isResolved ? 'Reopen' : 'Resolve'}</button>
                <button class="btn-icon" onclick="deleteIssue(${i.id})" title="Remove">&times;</button>
            </div>` : ''}
            <div class="issue-card-header">
                <input type="text" class="issue-text-input" value="${esc(i.issue)}"
                    oninput="debounceSave(${i.id},'issue',this.value)"
                    onchange="updateField(${i.id},'issue',this.value)"
                    ${!CAN_EDIT ? 'disabled' : ''}>
                <div class="issue-badges">
                    <select class="badge ${pClass}" onchange="updatePriority(${i.id},this)" ${!CAN_EDIT ? 'disabled' : ''}>
                        <option value="HIGH" ${i.priority==='HIGH'?'selected':''}>HIGH</option>
                        <option value="MEDIUM" ${i.priority==='MEDIUM'?'selected':''}>MEDIUM</option>
                        <option value="LOW" ${i.priority==='LOW'?'selected':''}>LOW</option>
                    </select>
                    <select class="badge ${idsClass}" onchange="updateIDS(${i.id},this)" ${!CAN_EDIT ? 'disabled' : ''}>
                        <option value="IDENTIFY" ${i.ids_stage==='IDENTIFY'?'selected':''}>IDENTIFY</option>
                        <option value="DISCUSS" ${i.ids_stage==='DISCUSS'?'selected':''}>DISCUSS</option>
                        <option value="SOLVE" ${i.ids_stage==='SOLVE'?'selected':''}>SOLVE</option>
                    </select>
                </div>
            </div>
            <div class="issue-meta">
                <div class="meta-group">
                    <span class="meta-label">Owner</span>
                    <input type="text" class="meta-value-input" value="${esc(i.owner || i.owner_full_name || i.owner_name || '')}"
                        placeholder="Unassigned" onchange="updateField(${i.id},'owner',this.value)"
                        ${!CAN_EDIT ? 'disabled' : ''}>
                </div>
                <div class="meta-group">
                    <span class="meta-label">Category</span>
                    <select class="meta-value-input" style="cursor:pointer;"
                        onchange="updateField(${i.id},'category',this.value)" ${!CAN_EDIT ? 'disabled' : ''}>
                        <option value="ADMINISTRATIVE" ${i.category==='ADMINISTRATIVE'?'selected':''}>Admin</option>
                        <option value="CUSTOMER" ${i.category==='CUSTOMER'?'selected':''}>Customer</option>
                        <option value="EMPLOYEE" ${i.category==='EMPLOYEE'?'selected':''}>Employee</option>
                        <option value="PROCESS" ${i.category==='PROCESS'?'selected':''}>Process</option>
                        <option value="FINANCIAL" ${i.category==='FINANCIAL'?'selected':''}>Financial</option>
                        <option value="STRATEGIC" ${i.category==='STRATEGIC'?'selected':''}>Strategic</option>
                    </select>
                </div>
                <div class="meta-group">
                    <span class="meta-label">Created</span>
                    <span class="meta-value-input" style="color:#888;">${i.created_date || 'Unknown'}</span>
                </div>
            </div>
            <div class="issue-notes-section" id="notes-${i.id}">
                <div class="meta-label" style="margin-bottom:8px;">Discussion Notes / Solution</div>
                <textarea placeholder="Add notes, discussion points, or the solution..."
                    onchange="updateField(${i.id},'discussion_notes',this.value)"
                    oninput="debounceSave(${i.id},'discussion_notes',this.value)"
                    ${!CAN_EDIT ? 'disabled' : ''}>${esc(i.discussion_notes || '')}</textarea>
            </div>
        </div>`;
    }

    function toggleNotes(id) {
        const el = document.getElementById('notes-' + id);
        if (el) el.classList.toggle('visible');
    }

    function addIssue() {
        const issue = document.getElementById('qaIssue').value.trim();
        if (!issue) { document.getElementById('qaIssue').focus(); return; }
        const owner = document.getElementById('qaOwner').value;
        const priority = document.getElementById('qaPriority').value;
        const category = document.getElementById('qaCategory').value;
        api('/api/division/' + DIVISION_ID + '/issues', {
            method: 'POST', body: { issue, owner, priority, category }
        }).then(data => {
            if (data.success) { document.getElementById('qaIssue').value = ''; showToast('Issue identified', 'success'); loadIssues(); }
        }).catch(() => showToast('Failed to add', 'error'));
    }

    function updateField(id, field, value) {
        clearTimeout(saveTimers[id + '_' + field]);
        api('/api/division/' + DIVISION_ID + '/issues/' + id, {
            method: 'PUT', body: { [field]: value }
        }).then(data => { if (data.success) { const i = allIssues.find(x => x.id === id); if (i) i[field] = value; } })
            .catch(() => showToast('Save failed', 'error'));
    }

    function updatePriority(id, selectEl) {
        const val = selectEl.value;
        selectEl.className = 'badge badge-' + val;
        updateField(id, 'priority', val);
    }

    function updateIDS(id, selectEl) {
        const val = selectEl.value;
        selectEl.className = 'badge badge-' + val;
        updateField(id, 'ids_stage', val);
        if (val === 'SOLVE') resolveIssue(id, true);
    }

    function debounceSave(id, field, value) {
        clearTimeout(saveTimers[id + '_' + field]);
        saveTimers[id + '_' + field] = setTimeout(() => updateField(id, field, value), 1200);
    }

    function resolveIssue(id, resolved) {
        api('/api/division/' + DIVISION_ID + '/issues/' + id + '/resolve', {
            method: 'POST', body: { resolved }
        }).then(data => {
            if (data.success) {
                const i = allIssues.find(x => x.id === id);
                if (i) { i.status = resolved ? 'RESOLVED' : 'OPEN'; i.ids_stage = resolved ? 'SOLVE' : 'IDENTIFY'; }
                render();
                showToast(resolved ? 'Issue resolved!' : 'Reopened', 'success');
            }
        }).catch(() => showToast('Failed to update', 'error'));
    }

    function deleteIssue(id) {
        if (!confirm('Remove this issue?')) return;
        api('/api/division/' + DIVISION_ID + '/issues/' + id, { method: 'DELETE' })
            .then(data => { if (data.success) { allIssues = allIssues.filter(x => x.id !== id); render(); showToast('Issue removed', 'success'); } })
            .catch(() => showToast('Failed to delete', 'error'));
    }

    function showToast(msg, type) {
        const t = document.getElementById('toast');
        t.textContent = msg; t.className = 'toast toast-' + (type || 'success') + ' visible';
        setTimeout(() => t.classList.remove('visible'), 2500);
    }

    loadIssues();
    </script>
</body>
</html>
