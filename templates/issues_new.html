<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Issues - {{ division.display_name }} - EOS Platform</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Inter', Arial, sans-serif;
            background: #f5f5f5; color: #2a2a2a; line-height: 1.6;
        }
        .header {
            background: #1a1a1a; color: white; padding: 14px 40px;
            display: flex; justify-content: space-between; align-items: center;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1); position: sticky; top: 0; z-index: 100;
        }
        .header-left { display: flex; align-items: center; gap: 16px; }
        .back-link { color: #b0b0b0; text-decoration: none; font-size: 14px; transition: color 0.2s; }
        .back-link:hover { color: white; }
        .header h1 { font-size: 22px; font-weight: 600; }
        .header-right { display: flex; gap: 12px; align-items: center; }
        .user-info { font-size: 13px; color: #888; }

        .btn {
            padding: 8px 18px; border-radius: 6px; font-size: 13px; font-weight: 600;
            cursor: pointer; border: none; transition: all 0.2s; text-decoration: none;
            display: inline-flex; align-items: center; gap: 6px;
        }
        .btn-success { background: #00aa55; color: white; }
        .btn-success:hover { background: #008844; }
        .btn-sm { padding: 5px 12px; font-size: 12px; }
        .btn-logout {
            padding: 6px 14px; background: transparent; border: 1px solid #4a4a4a;
            color: white; border-radius: 4px; font-size: 12px; text-decoration: none;
        }
        .btn-brainstorm {
            padding: 8px 16px; background: #7c3aed; color: white; border-radius: 6px;
            font-size: 13px; font-weight: 600; text-decoration: none;
        }
        .btn-brainstorm:hover { background: #6d28d9; }

        .container { max-width: 1200px; margin: 24px auto; padding: 0 32px; }

        /* Summary Strip */
        .summary-strip {
            display: flex; gap: 24px; margin-bottom: 20px; padding: 16px 24px;
            background: white; border-radius: 10px; box-shadow: 0 2px 6px rgba(0,0,0,0.05);
            flex-wrap: wrap;
        }
        .summary-item { display: flex; flex-direction: column; align-items: center; min-width: 70px; }
        .summary-num { font-size: 28px; font-weight: 700; line-height: 1; }
        .summary-label { font-size: 11px; color: #888; text-transform: uppercase; letter-spacing: 0.5px; margin-top: 4px; }

        /* Filters */
        .filter-bar {
            display: flex; gap: 8px; margin-bottom: 16px; align-items: center; flex-wrap: wrap;
        }
        .filter-btn {
            padding: 6px 14px; border-radius: 20px; font-size: 12px; font-weight: 600;
            cursor: pointer; border: 1px solid #e0e0e0; background: white; color: #555;
            transition: all 0.2s;
        }
        .filter-btn.active { background: #1a1a1a; color: white; border-color: #1a1a1a; }
        .filter-btn:hover { border-color: #999; }

        /* Quick Add Bar */
        .quick-add {
            display: flex; gap: 8px; margin-bottom: 20px; padding: 12px 16px;
            background: white; border-radius: 10px; box-shadow: 0 2px 6px rgba(0,0,0,0.05);
            align-items: center; flex-wrap: wrap;
        }
        .quick-add input, .quick-add select {
            padding: 8px 12px; border: 1px solid #e0e0e0; border-radius: 6px;
            font-size: 14px; outline: none; transition: border-color 0.2s;
        }
        .quick-add input:focus, .quick-add select:focus { border-color: #00aa55; }
        .quick-add input[type="text"] { flex: 1; min-width: 220px; }
        .quick-add select { min-width: 110px; }

        /* Issue Row */
        .issue-panel {
            background: white; border-radius: 10px; box-shadow: 0 2px 6px rgba(0,0,0,0.05);
            overflow: hidden; margin-bottom: 16px;
        }
        .issue-panel-header {
            padding: 14px 20px; font-size: 13px; font-weight: 700; color: #6a6a6a;
            text-transform: uppercase; letter-spacing: 0.5px; border-bottom: 1px solid #eee;
            display: flex; justify-content: space-between; align-items: center;
        }

        .issue-row {
            display: grid;
            grid-template-columns: 1fr 120px 80px 90px 80px 44px;
            gap: 8px; align-items: center; padding: 10px 20px;
            border-bottom: 1px solid #f0f0f0; transition: background 0.15s;
        }
        .issue-row:hover { background: #fafafa; }
        .issue-row:last-child { border-bottom: none; }
        .issue-row.resolved { opacity: 0.45; }
        .issue-row.resolved .issue-text { text-decoration: line-through; color: #aaa; }

        .issue-text {
            font-size: 14px; font-weight: 500; border: none; background: transparent;
            width: 100%; padding: 4px 0; outline: none; color: #2a2a2a;
        }
        .issue-text:focus { border-bottom: 2px solid #00aa55; }

        .issue-owner {
            font-size: 13px; border: none; background: transparent;
            padding: 4px 0; color: #555; outline: none; width: 100%;
        }
        .issue-owner:focus { border-bottom: 2px solid #2563eb; }

        .issue-priority {
            font-size: 11px; font-weight: 700; padding: 2px 8px; border-radius: 10px;
            border: none; cursor: pointer; text-transform: uppercase; text-align: center;
            outline: none; -webkit-appearance: none; appearance: none;
        }
        .priority-HIGH { background: #fee2e2; color: #991b1b; }
        .priority-MEDIUM { background: #fef3c7; color: #92400e; }
        .priority-LOW { background: #d1fae5; color: #065f46; }

        .issue-ids {
            font-size: 11px; font-weight: 700; padding: 4px 8px; border-radius: 10px;
            border: none; cursor: pointer; text-align: center;
            outline: none; -webkit-appearance: none; appearance: none;
        }
        .ids-IDENTIFY { background: #dbeafe; color: #1e40af; }
        .ids-DISCUSS { background: #e0e7ff; color: #4338ca; }
        .ids-SOLVE { background: #d4edda; color: #155724; }

        .issue-category {
            font-size: 11px; font-weight: 600; padding: 2px 8px; border-radius: 10px;
            border: none; cursor: pointer; text-align: center;
            outline: none; -webkit-appearance: none; appearance: none;
            background: #f3f4f6; color: #374151;
        }

        .issue-resolve-btn {
            background: none; border: 1px solid #ccc; color: #888; font-size: 11px;
            cursor: pointer; padding: 3px 8px; border-radius: 4px; transition: all 0.2s;
            font-weight: 600;
        }
        .issue-resolve-btn:hover { background: #00aa55; color: white; border-color: #00aa55; }

        .issue-delete {
            background: none; border: none; color: #ccc; font-size: 16px;
            cursor: pointer; padding: 4px; transition: color 0.2s;
        }
        .issue-delete:hover { color: #dc3545; }

        /* Empty state */
        .empty-state {
            text-align: center; padding: 48px 20px; color: #aaa; font-size: 15px;
        }

        /* Toast */
        .toast {
            position: fixed; bottom: 24px; right: 24px; padding: 12px 24px;
            background: #1a1a1a; color: white; border-radius: 8px; font-size: 14px;
            transform: translateY(80px); opacity: 0; transition: all 0.3s;
            z-index: 999;
        }
        .toast.visible { transform: translateY(0); opacity: 1; }
        .toast.toast-success { background: #00aa55; }
        .toast.toast-error { background: #dc3545; }

        /* Expandable notes row */
        .issue-notes-row {
            padding: 8px 20px 12px 20px; background: #fafbfc; border-bottom: 1px solid #f0f0f0;
            display: none;
        }
        .issue-notes-row.visible { display: block; }
        .issue-notes-row textarea {
            width: 100%; min-height: 60px; border: 1px solid #e0e0e0; border-radius: 6px;
            padding: 8px 12px; font-size: 13px; font-family: inherit; resize: vertical;
            outline: none;
        }
        .issue-notes-row textarea:focus { border-color: #2563eb; }
        .notes-label { font-size: 11px; color: #888; text-transform: uppercase; margin-bottom: 4px; font-weight: 600; }

        @media (max-width: 900px) {
            .container { padding: 0 12px; }
            .issue-row { grid-template-columns: 1fr 100px 70px 44px; gap: 4px; }
            .issue-row .issue-ids, .issue-row .issue-category { display: none; }
            .summary-strip { gap: 16px; }
            .quick-add { flex-wrap: wrap; }
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="header-left">
            <a href="{{ url_for('division_dashboard', division_id=division.id) }}" class="back-link">&#8592; {{ division.display_name }}</a>
            <h1>Issues List</h1>
        </div>
        <div class="header-right">
            <span class="user-info">{{ user.full_name or user.username }}</span>
            <a href="{{ url_for('issue_brainstorm', division_id=division.id) }}" class="btn-brainstorm">&#9889; Brainstorm</a>
            <a href="{{ url_for('logout') }}" class="btn-logout">Logout</a>
        </div>
    </div>

    <div class="container">
        <!-- Summary Strip -->
        <div class="summary-strip">
            <div class="summary-item">
                <div class="summary-num" id="statTotal">0</div>
                <div class="summary-label">Total</div>
            </div>
            <div class="summary-item">
                <div class="summary-num" style="color:#dc3545;" id="statOpen">0</div>
                <div class="summary-label">Open</div>
            </div>
            <div class="summary-item">
                <div class="summary-num" style="color:#f59e0b;" id="statInProgress">0</div>
                <div class="summary-label">In Progress</div>
            </div>
            <div class="summary-item">
                <div class="summary-num" style="color:#00aa55;" id="statResolved">0</div>
                <div class="summary-label">Resolved</div>
            </div>
            <div class="summary-item">
                <div class="summary-num" style="color:#991b1b;" id="statHigh">0</div>
                <div class="summary-label">High Pri</div>
            </div>
        </div>

        <!-- Filter Bar -->
        <div class="filter-bar">
            <button class="filter-btn active" onclick="setFilter('ALL',this)">All</button>
            <button class="filter-btn" onclick="setFilter('OPEN',this)">Open</button>
            <button class="filter-btn" onclick="setFilter('IN PROGRESS',this)">In Progress</button>
            <button class="filter-btn" onclick="setFilter('RESOLVED',this)">Resolved</button>
            <span style="color:#ccc;">|</span>
            <button class="filter-btn" onclick="setFilter('HIGH',this)">High</button>
            <button class="filter-btn" onclick="setFilter('MEDIUM',this)">Medium</button>
            <button class="filter-btn" onclick="setFilter('LOW',this)">Low</button>
        </div>

        <!-- Quick Add -->
        {% if can_edit %}
        <div class="quick-add" id="quickAdd">
            <input type="text" id="qaIssue" placeholder="Identify a new issue..." onkeydown="if(event.key==='Enter')addIssue()">
            <select id="qaOwner">
                <option value="">Owner...</option>
                {% for u in users %}
                <option value="{{ u.full_name }}">{{ u.full_name }}</option>
                {% endfor %}
            </select>
            <select id="qaPriority">
                <option value="MEDIUM">Med</option>
                <option value="HIGH">High</option>
                <option value="LOW">Low</option>
            </select>
            <select id="qaCategory">
                <option value="ADMINISTRATIVE">Admin</option>
                <option value="CUSTOMER">Customer</option>
                <option value="EMPLOYEE">Employee</option>
                <option value="PROCESS">Process</option>
                <option value="FINANCIAL">Financial</option>
                <option value="STRATEGIC">Strategic</option>
            </select>
            <button class="btn btn-success btn-sm" onclick="addIssue()">+ Add Issue</button>
        </div>
        {% endif %}

        <!-- Open / Active Issues -->
        <div class="issue-panel" id="openPanel">
            <div class="issue-panel-header">
                <span>Issues (<span id="openCount">0</span>)</span>
            </div>
            <div id="issueList"></div>
        </div>

        <!-- Resolved Issues -->
        <div class="issue-panel" id="resolvedPanel" style="opacity:0.6; display:none;">
            <div class="issue-panel-header">
                <span>Resolved (<span id="resolvedCount">0</span>)</span>
            </div>
            <div id="resolvedList"></div>
        </div>
    </div>

    <!-- Toast -->
    <div class="toast" id="toast"></div>

    <script>
    const DIVISION_ID = {{ division.id }};
    const CAN_EDIT = {{ 'true' if can_edit else 'false' }};
    let allIssues = [];
    let saveTimers = {};
    let currentFilter = 'ALL';

    // ===== API HELPER =====
    function api(url, opts) {
        opts = opts || {};
        opts.headers = opts.headers || {};
        if (opts.body && typeof opts.body === 'object' && !(opts.body instanceof FormData)) {
            opts.headers['Content-Type'] = 'application/json';
            opts.body = JSON.stringify(opts.body);
        }
        return fetch(url, opts).then(function(r) {
            if (!r.ok) throw new Error('HTTP ' + r.status);
            return r.json();
        });
    }

    // ===== LOAD ISSUES =====
    function loadIssues() {
        api('/api/division/' + DIVISION_ID + '/issues/all')
            .then(function(data) {
                allIssues = data.issues || data;
                render();
            })
            .catch(function() { showToast('Failed to load issues', 'error'); });
    }

    // ===== FILTER =====
    function setFilter(f, btn) {
        currentFilter = f;
        document.querySelectorAll('.filter-btn').forEach(function(b) { b.classList.remove('active'); });
        if (btn) btn.classList.add('active');
        render();
    }

    function filterIssues(issues) {
        if (currentFilter === 'ALL') return issues;
        if (['HIGH','MEDIUM','LOW'].indexOf(currentFilter) >= 0) {
            return issues.filter(function(i) { return i.priority === currentFilter; });
        }
        return issues.filter(function(i) { return i.status === currentFilter; });
    }

    // ===== RENDER =====
    function render() {
        var open = allIssues.filter(function(i) { return i.status !== 'RESOLVED'; });
        var resolved = allIssues.filter(function(i) { return i.status === 'RESOLVED'; });

        var filteredOpen = filterIssues(open);
        var filteredResolved = filterIssues(resolved);

        document.getElementById('issueList').innerHTML = filteredOpen.length
            ? filteredOpen.map(function(i) { return issueRow(i, false); }).join('')
            : '<div class="empty-state">No open issues. Nice work!</div>';

        document.getElementById('resolvedList').innerHTML = filteredResolved.map(function(i) {
            return issueRow(i, true);
        }).join('');

        document.getElementById('openCount').textContent = filteredOpen.length;
        document.getElementById('resolvedCount').textContent = filteredResolved.length;
        document.getElementById('resolvedPanel').style.display = filteredResolved.length ? 'block' : 'none';

        // Summary stats (always from full list)
        document.getElementById('statTotal').textContent = allIssues.length;
        document.getElementById('statOpen').textContent = open.filter(function(i) { return i.status === 'OPEN'; }).length;
        document.getElementById('statInProgress').textContent = open.filter(function(i) { return i.status === 'IN PROGRESS'; }).length;
        document.getElementById('statResolved').textContent = resolved.length;
        document.getElementById('statHigh').textContent = allIssues.filter(function(i) { return i.priority === 'HIGH' && i.status !== 'RESOLVED'; }).length;
    }

    function esc(str) {
        var d = document.createElement('div');
        d.textContent = str || '';
        return d.innerHTML;
    }

    function issueRow(i, isResolved) {
        var pClass = 'priority-' + (i.priority || 'MEDIUM');
        var idsClass = 'ids-' + (i.ids_stage || 'IDENTIFY');
        var resolveLabel = isResolved ? 'Reopen' : 'Resolve';

        return '<div class="issue-row' + (isResolved ? ' resolved' : '') + '" data-id="' + i.id + '">' +
            '<div style="display:flex;align-items:center;gap:6px;">' +
                '<input type="text" class="issue-text" value="' + esc(i.issue) + '"' +
                    ' oninput="debounceSave(' + i.id + ',\'issue\',this.value)"' +
                    ' onchange="updateField(' + i.id + ',\'issue\',this.value)"' +
                    (!CAN_EDIT ? ' disabled' : '') + '>' +
                '<button style="background:none;border:none;color:#bbb;cursor:pointer;font-size:14px;" ' +
                    'onclick="toggleNotes(' + i.id + ')" title="Notes">&#9998;</button>' +
            '</div>' +
            '<input type="text" class="issue-owner" value="' + esc(i.owner || i.owner_full_name || i.owner_name || '') + '"' +
                ' placeholder="Owner..."' +
                ' onchange="updateField(' + i.id + ',\'owner\',this.value)"' +
                (!CAN_EDIT ? ' disabled' : '') + '>' +
            '<select class="issue-priority ' + pClass + '"' +
                ' onchange="updateField(' + i.id + ',\'priority\',this.value); this.className=\'issue-priority priority-\'+this.value;"' +
                (!CAN_EDIT ? ' disabled' : '') + '>' +
                '<option value="HIGH"' + (i.priority==='HIGH'?' selected':'') + '>HIGH</option>' +
                '<option value="MEDIUM"' + (i.priority==='MEDIUM'?' selected':'') + '>MED</option>' +
                '<option value="LOW"' + (i.priority==='LOW'?' selected':'') + '>LOW</option>' +
            '</select>' +
            '<select class="issue-ids ' + idsClass + '"' +
                ' onchange="updateIDS(' + i.id + ',this)"' +
                (!CAN_EDIT ? ' disabled' : '') + '>' +
                '<option value="IDENTIFY"' + (i.ids_stage==='IDENTIFY'?' selected':'') + '>I</option>' +
                '<option value="DISCUSS"' + (i.ids_stage==='DISCUSS'?' selected':'') + '>D</option>' +
                '<option value="SOLVE"' + (i.ids_stage==='SOLVE'?' selected':'') + '>S</option>' +
            '</select>' +
            (CAN_EDIT ?
                '<button class="issue-resolve-btn" onclick="resolveIssue(' + i.id + ',' + (!isResolved) + ')">' + resolveLabel + '</button>' +
                '<button class="issue-delete" onclick="deleteIssue(' + i.id + ')" title="Remove">&times;</button>'
            : '<span></span><span></span>') +
        '</div>' +
        '<div class="issue-notes-row" id="notes-' + i.id + '">' +
            '<div class="notes-label">Discussion Notes / Solution</div>' +
            '<textarea placeholder="Add notes..."' +
                ' onchange="updateField(' + i.id + ',\'discussion_notes\',this.value)"' +
                ' oninput="debounceSave(' + i.id + ',\'discussion_notes\',this.value)"' +
                (!CAN_EDIT ? ' disabled' : '') + '>' + esc(i.discussion_notes || '') + '</textarea>' +
        '</div>';
    }

    // ===== TOGGLE NOTES =====
    function toggleNotes(id) {
        var el = document.getElementById('notes-' + id);
        if (el) el.classList.toggle('visible');
    }

    // ===== ADD ISSUE =====
    function addIssue() {
        var issue = document.getElementById('qaIssue').value.trim();
        if (!issue) { document.getElementById('qaIssue').focus(); return; }
        var owner = document.getElementById('qaOwner').value;
        var priority = document.getElementById('qaPriority').value;
        var category = document.getElementById('qaCategory').value;

        api('/api/division/' + DIVISION_ID + '/issues', {
            method: 'POST',
            body: { issue: issue, owner: owner, priority: priority, category: category }
        }).then(function(data) {
            if (data.success) {
                document.getElementById('qaIssue').value = '';
                showToast('Issue added', 'success');
                loadIssues();
            }
        }).catch(function() { showToast('Failed to add', 'error'); });
    }

    // ===== UPDATE FIELD =====
    function updateField(id, field, value) {
        clearTimeout(saveTimers[id + '_' + field]);
        api('/api/division/' + DIVISION_ID + '/issues/' + id, {
            method: 'PUT',
            body: { [field]: value }
        }).then(function(data) {
            if (data.success) {
                var i = allIssues.find(function(x) { return x.id === id; });
                if (i) i[field] = value;
            }
        }).catch(function() { showToast('Save failed', 'error'); });
    }

    function updateIDS(id, selectEl) {
        var val = selectEl.value;
        selectEl.className = 'issue-ids ids-' + val;
        updateField(id, 'ids_stage', val);
        // If SOLVE, auto-resolve
        if (val === 'SOLVE') {
            resolveIssue(id, true);
        }
    }

    function debounceSave(id, field, value) {
        clearTimeout(saveTimers[id + '_' + field]);
        saveTimers[id + '_' + field] = setTimeout(function() {
            updateField(id, field, value);
        }, 1200);
    }

    // ===== RESOLVE / REOPEN =====
    function resolveIssue(id, resolved) {
        api('/api/division/' + DIVISION_ID + '/issues/' + id + '/resolve', {
            method: 'POST',
            body: { resolved: resolved }
        }).then(function(data) {
            if (data.success) {
                var i = allIssues.find(function(x) { return x.id === id; });
                if (i) {
                    i.status = resolved ? 'RESOLVED' : 'OPEN';
                    i.ids_stage = resolved ? 'SOLVE' : 'IDENTIFY';
                }
                render();
                showToast(resolved ? 'Issue resolved!' : 'Reopened', 'success');
            }
        }).catch(function() { showToast('Failed to update', 'error'); });
    }

    // ===== DELETE =====
    function deleteIssue(id) {
        if (!confirm('Remove this issue?')) return;
        api('/api/division/' + DIVISION_ID + '/issues/' + id, {
            method: 'DELETE'
        }).then(function(data) {
            if (data.success) {
                allIssues = allIssues.filter(function(x) { return x.id !== id; });
                render();
                showToast('Issue removed', 'success');
            }
        }).catch(function() { showToast('Failed to delete', 'error'); });
    }

    // ===== TOAST =====
    function showToast(msg, type) {
        var t = document.getElementById('toast');
        t.textContent = msg;
        t.className = 'toast toast-' + (type || 'success') + ' visible';
        setTimeout(function() { t.classList.remove('visible'); }, 2500);
    }

    // ===== INIT =====
    loadIssues();
    </script>
</body>
</html>
