<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quarterly Rocks - {{ division.display_name }} - EOS Platform</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Inter', Arial, sans-serif;
            background: #f5f5f5; color: #2a2a2a; line-height: 1.6;
        }

        /* === HEADER === */
        .header {
            background: #1a1a1a; color: white; padding: 20px 40px;
            display: flex; justify-content: space-between; align-items: center;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        .header-left { display: flex; align-items: center; gap: 16px; }
        .back-link { color: #b0b0b0; text-decoration: none; font-size: 14px; transition: color 0.2s; }
        .back-link:hover { color: white; }
        .header h1 { font-size: 24px; font-weight: 600; }
        .header-right { display: flex; gap: 16px; align-items: center; }
        .user-info { font-size: 14px; color: #b0b0b0; }
        .btn-logout {
            padding: 8px 16px; background: transparent; border: 1px solid #4a4a4a;
            color: white; border-radius: 4px; font-size: 13px; text-decoration: none; transition: all 0.2s;
        }
        .btn-logout:hover { background: #2d2d2d; border-color: #6a6a6a; }

        /* === LAYOUT === */
        .container { max-width: 1400px; margin: 40px auto; padding: 0 40px; }
        .page-title { margin-bottom: 32px; }
        .page-title h2 { font-size: 32px; font-weight: 700; letter-spacing: -0.02em; margin-bottom: 4px; }
        .page-title p { font-size: 14px; color: #6a6a6a; }

        /* === SUMMARY CARDS === */
        .summary-cards {
            display: grid; grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
            gap: 16px; margin-bottom: 32px;
        }
        .summary-card {
            background: white; padding: 24px; border-radius: 8px;
            border: 1px solid #e5e5e5; transition: all 0.2s;
        }
        .summary-card:hover { box-shadow: 0 4px 12px rgba(0,0,0,0.06); }
        .summary-card-label {
            font-size: 11px; color: #8a8a8a; text-transform: uppercase;
            letter-spacing: 0.05em; margin-bottom: 8px;
        }
        .summary-card-value { font-size: 32px; font-weight: 700; color: #1a1a1a; line-height: 1.2; }

        /* === QUICK ADD === */
        .quick-add-section {
            background: white; border: 1px solid #e0e0e0; border-radius: 8px;
            margin-bottom: 32px; overflow: hidden;
        }
        .quick-add-bar {
            display: flex; gap: 12px; padding: 16px 24px; align-items: center; flex-wrap: wrap;
        }
        .quick-add-bar input, .quick-add-bar select {
            padding: 10px 14px; border: 1px solid #e5e5e5; border-radius: 6px;
            font-size: 14px; outline: none; transition: border-color 0.2s; background: #fafafa;
        }
        .quick-add-bar input:focus, .quick-add-bar select:focus { border-color: #1a1a1a; background: white; }
        .quick-add-bar input[type="text"] { flex: 1; min-width: 220px; }
        .quick-add-bar select { min-width: 120px; }
        .btn-add {
            padding: 10px 20px; background: #1a1a1a; color: white; border: none;
            border-radius: 6px; font-size: 14px; font-weight: 600; cursor: pointer;
            transition: all 0.2s; white-space: nowrap;
        }
        .btn-add:hover { background: #333; }

        /* === SECTION === */
        .section { margin-bottom: 32px; }
        .section-header {
            font-size: 13px; font-weight: 700; color: #6a6a6a; text-transform: uppercase;
            letter-spacing: 0.05em; margin-bottom: 16px; padding-bottom: 8px;
            border-bottom: 2px solid #e5e5e5; display: flex; justify-content: space-between;
        }

        /* === ROCK CARD === */
        .rock-card {
            background: white; border: 1px solid #e5e5e5; border-radius: 8px;
            padding: 24px; margin-bottom: 16px; transition: all 0.2s;
            position: relative; overflow: hidden;
        }
        .rock-card:hover { border-color: #ccc; box-shadow: 0 4px 12px rgba(0,0,0,0.06); }

        .rock-card-header {
            display: flex; justify-content: space-between; align-items: flex-start;
            margin-bottom: 16px; gap: 16px;
        }
        .rock-desc-input {
            font-size: 16px; font-weight: 600; color: #1a1a1a; border: none;
            background: transparent; outline: none; width: 100%; padding: 0;
            flex: 1; min-width: 0;
        }
        .rock-desc-input:focus { border-bottom: 2px solid #1a1a1a; padding-bottom: 2px; }

        .status-select {
            font-size: 11px; font-weight: 700; padding: 6px 14px; border-radius: 4px;
            border: none; cursor: pointer; text-transform: uppercase; letter-spacing: 0.05em;
            outline: none; -webkit-appearance: none; appearance: none; white-space: nowrap;
            flex-shrink: 0;
        }
        .status-COMPLETE { background: #d4edda; color: #155724; }
        .status-ON_TRACK { background: #d1ecf1; color: #0c5460; }
        .status-AT_RISK { background: #fff3cd; color: #856404; }
        .status-NOT_STARTED { background: #f8f9fa; color: #6c757d; }
        .status-OFF_TRACK { background: #f8d7da; color: #721c24; }

        .rock-meta {
            display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 16px; margin-bottom: 16px;
        }
        .meta-group { display: flex; flex-direction: column; }
        .meta-label {
            font-size: 11px; color: #8a8a8a; text-transform: uppercase;
            letter-spacing: 0.05em; margin-bottom: 4px;
        }
        .meta-value-input {
            font-size: 14px; font-weight: 500; color: #1a1a1a; border: none;
            background: transparent; outline: none; padding: 2px 0;
        }
        .meta-value-input:focus { border-bottom: 1px solid #1a1a1a; }
        .meta-value-input::placeholder { color: #ccc; }

        .rock-progress-section {
            display: flex; align-items: center; gap: 12px;
        }
        .progress-track {
            flex: 1; height: 8px; background: #e5e5e5; border-radius: 4px;
            overflow: hidden; position: relative; cursor: pointer;
        }
        .progress-fill {
            height: 100%; border-radius: 4px;
            background: linear-gradient(90deg, #4a4a4a 0%, #1a1a1a 100%);
            transition: width 0.3s ease;
        }
        .progress-fill.green { background: linear-gradient(90deg, #059669 0%, #047857 100%); }
        .progress-slider {
            width: 100%; cursor: pointer; accent-color: #1a1a1a;
        }
        .progress-pct {
            font-size: 14px; font-weight: 700; color: #1a1a1a; min-width: 40px; text-align: right;
        }

        .rock-actions {
            position: absolute; top: 16px; right: 16px;
            opacity: 0; transition: opacity 0.2s;
        }
        .rock-card:hover .rock-actions { opacity: 1; }
        .btn-icon {
            background: none; border: none; color: #ccc; font-size: 18px;
            cursor: pointer; padding: 4px 8px; border-radius: 4px; transition: all 0.15s;
        }
        .btn-icon:hover { color: #dc3545; background: #fef2f2; }

        /* === COMPLETE SECTION === */
        .complete-section .rock-card { opacity: 0.5; border-color: #f0f0f0; }
        .complete-section .rock-card:hover { opacity: 0.7; }
        .complete-section .rock-desc-input { text-decoration: line-through; color: #999; }

        /* === EMPTY STATE === */
        .empty-state {
            text-align: center; padding: 60px 40px; color: #999;
        }
        .empty-state-icon { font-size: 48px; margin-bottom: 16px; opacity: 0.3; }
        .empty-state h3 { font-size: 18px; font-weight: 600; color: #666; margin-bottom: 8px; }
        .empty-state p { font-size: 14px; }

        /* === TOAST === */
        .toast {
            position: fixed; bottom: 24px; right: 24px; padding: 14px 28px;
            background: #1a1a1a; color: white; border-radius: 8px; font-size: 14px;
            font-weight: 500; transform: translateY(80px); opacity: 0; transition: all 0.3s;
            z-index: 999; box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        .toast.visible { transform: translateY(0); opacity: 1; }
        .toast.toast-success { background: #065f46; }
        .toast.toast-error { background: #9b1c1c; }

        @media (max-width: 768px) {
            .container { padding: 0 16px; margin: 24px auto; }
            .summary-cards { grid-template-columns: repeat(2, 1fr); }
            .rock-meta { grid-template-columns: 1fr; }
            .quick-add-bar { flex-wrap: wrap; }
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="header-left">
            <a href="{{ url_for('division_dashboard', division_id=division.id) }}" class="back-link">&#8592; {{ division.display_name }}</a>
            <h1>Quarterly Rocks</h1>
        </div>
        <div class="header-right">
            <span class="user-info">{{ user.full_name }} ({{ user.role }})</span>
            <a href="{{ url_for('logout') }}" class="btn-logout">Logout</a>
        </div>
    </div>

    <div class="container">
        <div class="page-title">
            <h2>{{ division.display_name }} Rocks</h2>
            <p>90-day priorities and strategic objectives</p>
        </div>

        <!-- Summary Cards -->
        <div class="summary-cards">
            <div class="summary-card">
                <div class="summary-card-label">Total Rocks</div>
                <div class="summary-card-value" id="statTotal">0</div>
            </div>
            <div class="summary-card">
                <div class="summary-card-label">Complete</div>
                <div class="summary-card-value" style="color:#28a745;" id="statComplete">0</div>
            </div>
            <div class="summary-card">
                <div class="summary-card-label">On Track</div>
                <div class="summary-card-value" style="color:#17a2b8;" id="statOnTrack">0</div>
            </div>
            <div class="summary-card">
                <div class="summary-card-label">At Risk</div>
                <div class="summary-card-value" style="color:#ffc107;" id="statAtRisk">0</div>
            </div>
            <div class="summary-card">
                <div class="summary-card-label">Not Started</div>
                <div class="summary-card-value" style="color:#6c757d;" id="statNotStarted">0</div>
            </div>
            <div class="summary-card">
                <div class="summary-card-label">Completion</div>
                <div class="summary-card-value" id="statPct">0%</div>
            </div>
        </div>

        <!-- Quick Add -->
        {% if can_edit %}
        <div class="quick-add-section">
            <div class="quick-add-bar">
                <input type="text" id="qaDesc" placeholder="&#43; Add a new rock..." onkeydown="if(event.key==='Enter')addRock()">
                <select id="qaOwner">
                    <option value="">Owner...</option>
                    {% for u in users %}
                    <option value="{{ u.full_name }}">{{ u.full_name }}</option>
                    {% endfor %}
                </select>
                <select id="qaQuarter">
                    <option value="Q1">Q1</option>
                    <option value="Q2">Q2</option>
                    <option value="Q3">Q3</option>
                    <option value="Q4">Q4</option>
                </select>
                <button class="btn-add" onclick="addRock()">Add Rock</button>
            </div>
        </div>
        {% endif %}

        <!-- Active Rocks -->
        <div class="section" id="activeSection">
            <div class="section-header">
                <span>Active Rocks</span>
                <span id="activeCount">0</span>
            </div>
            <div id="activeList"></div>
        </div>

        <!-- Completed Rocks -->
        <div class="section complete-section" id="completeSection" style="display:none;">
            <div class="section-header">
                <span>Completed</span>
                <span id="completeCount">0</span>
            </div>
            <div id="completeList"></div>
        </div>
    </div>

    <!-- Toast -->
    <div class="toast" id="toast"></div>

    <script>
    const DIVISION_ID = {{ division.id }};
    const CAN_EDIT = {{ 'true' if can_edit else 'false' }};
    let allRocks = [];
    let saveTimers = {};

    (function() {
        const q = Math.ceil((new Date().getMonth() + 1) / 3);
        const sel = document.getElementById('qaQuarter');
        if (sel) sel.value = 'Q' + q;
    })();

    function api(url, opts = {}) {
        opts.headers = opts.headers || {};
        if (opts.body && typeof opts.body === 'object' && !(opts.body instanceof FormData)) {
            opts.headers['Content-Type'] = 'application/json';
            opts.body = JSON.stringify(opts.body);
        }
        return fetch(url, opts).then(r => { if (!r.ok) throw new Error('HTTP ' + r.status); return r.json(); });
    }

    function loadRocks() {
        api('/api/division/' + DIVISION_ID + '/rocks')
            .then(data => { allRocks = data.rocks || data; render(); })
            .catch(() => showToast('Failed to load rocks', 'error'));
    }

    function render() {
        const active = allRocks.filter(r => r.status !== 'COMPLETE');
        const complete = allRocks.filter(r => r.status === 'COMPLETE');

        document.getElementById('activeList').innerHTML = active.length
            ? active.map(r => rockCard(r)).join('')
            : `<div class="empty-state"><div class="empty-state-icon">&#127967;</div><h3>No Active Rocks</h3><p>Add your first 90-day priority above.</p></div>`;
        document.getElementById('completeList').innerHTML = complete.map(r => rockCard(r)).join('');
        document.getElementById('activeCount').textContent = active.length;
        document.getElementById('completeCount').textContent = complete.length;
        document.getElementById('completeSection').style.display = complete.length ? 'block' : 'none';

        const total = allRocks.length, cCount = complete.length;
        const onTrack = allRocks.filter(r => r.status === 'ON_TRACK').length;
        const atRisk = allRocks.filter(r => r.status === 'AT_RISK').length;
        const notStarted = allRocks.filter(r => r.status === 'NOT_STARTED').length;
        document.getElementById('statTotal').textContent = total;
        document.getElementById('statComplete').textContent = cCount;
        document.getElementById('statOnTrack').textContent = onTrack;
        document.getElementById('statAtRisk').textContent = atRisk;
        document.getElementById('statNotStarted').textContent = notStarted;
        document.getElementById('statPct').textContent = (total > 0 ? Math.round(cCount/total*100) : 0) + '%';
    }

    function esc(str) { const d = document.createElement('div'); d.textContent = str || ''; return d.innerHTML; }

    function rockCard(r) {
        const sCls = 'status-' + (r.status || 'NOT_STARTED').replace(' ', '_');
        const prog = r.progress || 0;
        const progClass = prog >= 70 ? ' green' : '';
        return `
        <div class="rock-card" data-id="${r.id}">
            ${CAN_EDIT ? '<div class="rock-actions"><button class="btn-icon" onclick="deleteRock('+r.id+')" title="Remove">&times;</button></div>' : ''}
            <div class="rock-card-header">
                <input type="text" class="rock-desc-input" value="${esc(r.description)}"
                    oninput="debounceSave(${r.id},'description',this.value)"
                    onchange="updateField(${r.id},'description',this.value)"
                    ${!CAN_EDIT ? 'disabled' : ''}>
                <select class="status-select ${sCls}" onchange="updateStatus(${r.id},this)" ${!CAN_EDIT ? 'disabled' : ''}>
                    <option value="NOT_STARTED" ${r.status==='NOT_STARTED'?'selected':''}>NOT STARTED</option>
                    <option value="ON_TRACK" ${r.status==='ON_TRACK'?'selected':''}>ON TRACK</option>
                    <option value="AT_RISK" ${r.status==='AT_RISK'?'selected':''}>AT RISK</option>
                    <option value="OFF_TRACK" ${r.status==='OFF_TRACK'?'selected':''}>OFF TRACK</option>
                    <option value="COMPLETE" ${r.status==='COMPLETE'?'selected':''}>COMPLETE</option>
                </select>
            </div>
            <div class="rock-meta">
                <div class="meta-group">
                    <span class="meta-label">Owner</span>
                    <input type="text" class="meta-value-input" value="${esc(r.owner || r.owner_full_name || '')}"
                        placeholder="Unassigned" onchange="updateField(${r.id},'owner',this.value)"
                        ${!CAN_EDIT ? 'disabled' : ''}>
                </div>
                <div class="meta-group">
                    <span class="meta-label">Due Date</span>
                    <input type="text" class="meta-value-input" value="${r.due_date || 'Not set'}"
                        onfocus="this.type='date'; if(this.value==='Not set')this.value='';"
                        onblur="if(!this.value){this.type='text';this.value='Not set';}"
                        onchange="updateField(${r.id},'due_date',this.value)"
                        ${!CAN_EDIT ? 'disabled' : ''}>
                </div>
                <div class="meta-group">
                    <span class="meta-label">Quarter</span>
                    <span class="meta-value-input" style="color:#555;">Q${r.quarter || '?'} ${r.year || ''}</span>
                </div>
                <div class="meta-group">
                    <span class="meta-label">Progress</span>
                    <span class="progress-pct" id="pct-${r.id}">${prog}%</span>
                </div>
            </div>
            <div class="rock-progress-section">
                <div class="progress-track">
                    <div class="progress-fill${progClass}" id="bar-${r.id}" style="width:${prog}%"></div>
                </div>
                <input type="range" class="progress-slider" min="0" max="100" value="${prog}"
                    style="display:none; width:100%;"
                    oninput="document.getElementById('pct-'+${r.id}).textContent=this.value+'%'; document.getElementById('bar-'+${r.id}).style.width=this.value+'%';"
                    onchange="updateField(${r.id},'progress',parseInt(this.value))"
                    ${!CAN_EDIT ? 'disabled' : ''}>
            </div>
        </div>`;
    }

    // Toggle slider on progress bar click
    document.addEventListener('click', function(e) {
        if (e.target.classList.contains('progress-track') || e.target.classList.contains('progress-fill')) {
            const card = e.target.closest('.rock-card');
            if (!card || !CAN_EDIT) return;
            const slider = card.querySelector('.progress-slider');
            const track = card.querySelector('.progress-track');
            if (slider.style.display === 'none') {
                slider.style.display = 'block'; track.style.display = 'none';
            } else {
                slider.style.display = 'none'; track.style.display = 'block';
            }
        }
    });

    function addRock() {
        const desc = document.getElementById('qaDesc').value.trim();
        if (!desc) { document.getElementById('qaDesc').focus(); return; }
        const owner = document.getElementById('qaOwner').value;
        const qVal = document.getElementById('qaQuarter').value;
        api('/api/division/' + DIVISION_ID + '/rocks', {
            method: 'POST', body: { description: desc, owner: owner, quarter: qVal, year: new Date().getFullYear() }
        }).then(data => {
            if (data.success) { document.getElementById('qaDesc').value = ''; showToast('Rock added', 'success'); loadRocks(); }
        }).catch(() => showToast('Failed to add rock', 'error'));
    }

    function updateField(id, field, value) {
        clearTimeout(saveTimers[id + '_' + field]);
        api('/api/division/' + DIVISION_ID + '/rocks/' + id, {
            method: 'PUT', body: { [field]: value }
        }).then(data => { if (data.success) { const r = allRocks.find(x => x.id === id); if (r) r[field] = value; } })
            .catch(() => showToast('Save failed', 'error'));
    }

    function updateStatus(id, selectEl) {
        const val = selectEl.value;
        selectEl.className = 'status-select status-' + val;
        updateField(id, 'status', val);
        if (val === 'COMPLETE') updateField(id, 'progress', 100);
        const r = allRocks.find(x => x.id === id);
        if (r) { r.status = val; if (val === 'COMPLETE') r.progress = 100; }
        render();
    }

    function debounceSave(id, field, value) {
        clearTimeout(saveTimers[id + '_' + field]);
        saveTimers[id + '_' + field] = setTimeout(() => updateField(id, field, value), 1200);
    }

    function deleteRock(id) {
        if (!confirm('Remove this rock?')) return;
        api('/api/division/' + DIVISION_ID + '/rocks/' + id, { method: 'DELETE' })
            .then(data => { if (data.success) { allRocks = allRocks.filter(x => x.id !== id); render(); showToast('Rock removed', 'success'); } })
            .catch(() => showToast('Failed to delete', 'error'));
    }

    function showToast(msg, type) {
        const t = document.getElementById('toast');
        t.textContent = msg; t.className = 'toast toast-' + (type || 'success') + ' visible';
        setTimeout(() => t.classList.remove('visible'), 2500);
    }

    loadRocks();
    </script>
</body>
</html>
